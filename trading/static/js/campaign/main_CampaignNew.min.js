var temp_data,farmers_all,farmer_data,manual_farmer_data,editable_target_list,org_settings,tags_data,counter=1,tag_ids=[],tag_arr=[],tags=[];function campaign_media_sms_check(){$("#campaign_channel_SMS")[0].checked?($("#campaign-media-images").attr("disabled",""),$("#campaign-media-doc").attr("disabled",""),$("#campaign-media-vid").attr("disabled",""),$('input[name="CampaignMedia"]').prop("checked",!1)):($("#campaign-media-images").removeAttr("disabled"),$("#campaign-media-doc").removeAttr("disabled"),$("#campaign-media-vid").removeAttr("disabled"))}function publish_form_data(a){for(key in farmer_data=(farmer_data=a.farmer_list).sort(function(a,e){return a.FarmerID-e.FarmerID}),a.target_groups)$("#TargetGroup").append($("<option>",{value:a.target_groups[key].FarmerGroupID,text:a.target_groups[key].GroupName}));for(key in a.campaign_groups)$("#CampaignGroup").append($("<option>",{value:a.campaign_groups[key].Group,text:a.campaign_groups[key].Group}));for(key in a.channels)"SMS"==a.channels[key].Channel?$("#channels_checkbox").append($("<input>",{name:"campaign_channel_"+a.channels[key].Channel,id:"campaign_channel_"+a.channels[key].Channel,value:a.channels[key].ChannelID,class:"filled-in",type:"checkbox",onchange:"campaign_media_sms_check();"})):$("#channels_checkbox").append($("<input>",{name:"campaign_channel_"+a.channels[key].Channel,id:"campaign_channel_"+a.channels[key].Channel,value:a.channels[key].ChannelID,class:"filled-in",type:"checkbox"})),$("#channels_checkbox").append($("<label>",{for:"campaign_channel_"+a.channels[key].Channel,text:a.channels[key].Channel,class:"block"}));for(key in a.TargetSelectionMode)$("#TargetSelectionMode").append($("<option>",{value:a.TargetSelectionMode[key].unnest,text:a.TargetSelectionMode[key].unnest}));$('option[value="Query"]').attr("disabled",""),$("#TargetSelectionMode").val(""),$("#TargetGroup").val(""),$("#CampaignGroup").val(""),$("#CampaignScheduledTime").val(get_curr_datetime()),$("#CampaignScheduledTime").attr("min",get_curr_datetime())}function get_form_data(){$.ajax({url:$SCRIPT_ROOT+"/get/campaigns/new",type:"GET",dataType:"json",success:function(a){tags_data=a.tag_data,publish_form_data(a)},error:function(a,e,t){console.log(t)}})}function publish_org_settings(a){org_settings=a}function get_org_settings(){$.ajax({url:$SCRIPT_ROOT+"/get/organizationsettings",type:"GET",dataType:"json",success:function(a){publish_org_settings(a)},error:function(a,e,t){console.log(t)}})}function table_initialization(){farmers_all=$("#farmers_all").DataTable({dom:"Bfrtip",buttons:["copy","csv","excel","pdf","print"],paging:!0,lengthChange:!1,searching:!0,ordering:!0,info:!0,autoWidth:!1,columns:[{width:"5%"},{width:"25%"},{width:"20%"},{width:"25%"},{width:"20%"},{width:"5%"}]})}function publish_edit_campaign(a){$("#CampaignName").val(a.campaign[0].Name),$("#CampaignDesc").val(a.campaign[0].Description),$("#TargetSelectionMode").val(a.campaign[0].TargetSelectionMode),$("#TargetSelectionMode").change(),$("#CampaignGroup").val(a.campaign[0].Group),"Group"==a.campaign[0].TargetSelectionMode&&$("#TargetGroup").val(a.campaign[0].TargetGroupID);var e=get_curr_datetime(a.campaign[0].StartDate);for(key in $("#CampaignScheduledTime").val(e),a.TargetChannel)$('input[name*="campaign_channel_"][value='+a.TargetChannel[key].ChannelID+"]").prop("checked",!0);campaign_media_sms_check(),$('input[name="CampaignMedia"][value="'+a.media[0].MediaType+'"]').prop("checked",!0),$('input[name="CampaignMedia"][value="'+a.media[0].MediaType+'"]').tab("show"),"Text"==a.media[0].MediaType?CKEDITOR.instances.campaign_media_Text.setData(a.media[0].Data):$('label[for="campaign_media_'+a.media[0].MediaType+'"]').text(a.media[0].Data),"Manual"==a.campaign[0].TargetSelectionMode&&(manual_farmer_data=a.EditTargetData),update_farmer_target_data(a.EditTargetData)}function get_edit_campaign(a){$.ajax({url:$SCRIPT_ROOT+"/get/campaign/details/"+a,type:"GET",dataType:"json",success:function(a){publish_edit_campaign(a)},error:function(a,e,t){console.log(t)}})}function update_farmer_target_data(a,e=!0){for(key in e&&(farmers_all.clear(),farmers_all.draw(),0==a.length?$("#ErrordivTargetList").html('<label class="error">Empty Target List</label>'):($("#ErrordivTargetList").html(""),a=a.sort(function(a,e){return a.FarmerID-e.FarmerID}))),a){if(100==key)break;farmers_all.row.add([a[key].FarmerID,a[key].FirstName+a[key].LastName,a[key].MobileNo,a[key].IDNo,a[key].Geography,a[key].CreatedBy]).node().id="rowid_"+a[key].FarmerID,farmers_all.draw(!1)}}function file_size_check(a){var e=$('input[name="'+a.name+'"]')[0].files;$('label[for="'+a.name+'"]').text(e[0].name);var t=$("input[name='CampaignMedia']:checked").val();return"Video/Audio"==t&&(t="VideoAudio"),e[0].size>org_settings[0].MaxMediaSize?($("#Error"+t+"Size").html('<label class="error">File with size not more than '+org_settings[0].MaxMediaSize/1e3+"kb are accepted</label>"),!1):($("#Error"+t+"Size").html(""),!0)}function get_curr_datetime(a=null){if(a)e=new Date(a);else var e=new Date($.now());return e.getFullYear()+"-"+(1===e.getMonth().toString().length?"0"+(e.getMonth()+1).toString():e.getMonth()+1)+"-"+(1===e.getDate().toString().length?"0"+e.getDate().toString():e.getDate())+"T"+(1===e.getHours().toString().length?"0"+e.getHours().toString():e.getHours())+":"+(1===e.getMinutes().toString().length?"0"+e.getMinutes().toString():e.getMinutes())}function table_loader(a,e){$("#"+e).hide(),$("#"+a).append('<div class="loader" id="loader_div"></div>')}function table_unloader(a,e){$("#"+e).show(),$("#"+a).remove()}function filter_by_tag(a,e,t){return a.filter(a=>a[e]===t)}function get_tag_any_data(){var a=$("#FarmerTags").tagsinput("items"),e=$(a).not(tags).get(),t=$(tags).not(a).get();if(tags=tags.concat(e),tags=$(tags).not(t).get(),t.length>0)return 0;var r=[];for(i in e)r=r.concat(filter_by_tag(tags_data,"TagName",e[i]));var n=Array.from(new Set(r.map(a=>a.FarmerID)));console.log(r);r=[];for(i in t)r=r.concat(filter_by_tag(tags_data,"TagName",t[i]));Array.from(new Set(r.map(a=>a.FarmerID)));console.log(r),n=$(n).not(tag_ids).get(),tag_ids=tag_ids.concat(n);var o=[];for(i in n)o=o.concat(filter_by_tag(farmer_data,"FarmerID",n[i]));return console.log(o),update_farmer_target_data(o,!1),1}$(document).ajaxStart(function(){}),$(document).ajaxStop(function(){table_unloader("loader_div","campaign_form")}),$(document).ready(function(){table_loader("loader_placer","campaign_form"),table_initialization(),get_form_data(),$("#DivTargetGroup").hide(),get_org_settings(),campid&&get_edit_campaign(campid)}),$(".media").on("change",function(){file_size_check(this)}),$('input[name="CampaignMedia"]').on("click",function(){$(this).tab("show"),$(this).removeClass("active")}),$("#TargetSelectionMode").on("change",function(){"Group"===$("#TargetSelectionMode").val()?($("#DivTargetGroup").show(),TargetID=parseInt($("#TargetGroup").val()),target_data=farmer_data.filter(a=>a.FarmerGroupID===TargetID),update_farmer_target_data(target_data),$("#TargetGroupManual").hide(),$("#TargetGroupTag").hide()):"All"===$("#TargetSelectionMode").val()?($("#DivTargetGroup").hide(),TargetID=parseInt($("#TargetGroup").val()),target_data=farmer_data,update_farmer_target_data(target_data),$("#TargetGroupManual").hide(),$("#TargetGroupTag").hide()):"Manual"===$("#TargetSelectionMode").val()?(farmers_all.clear(),farmers_all.draw(),$("#TargetGroupManual").show(),$("#DivTargetGroup").hide(),$("#TargetGroupTag").hide()):"Tags"===$("#TargetSelectionMode").val()?(farmers_all.clear(),farmers_all.draw(),$("#TargetGroupManual").hide(),$("#DivTargetGroup").hide(),$("#TargetGroupTag").show()):($("#TargetGroupManual").hide(),farmers_all.clear(),farmers_all.draw(),$("#DivTargetGroup").hide(),$("#TargetGroupTag").hide())}),$("#TargetGroup").on("change",function(){TargetID=parseInt($("#TargetGroup").val()),target_data=farmer_data.filter(a=>a.FarmerGroupID===TargetID),update_farmer_target_data(target_data)}),$("#upload_farmer_button").on("click",function(){for(var a=new FormData,e=$("#upload_farmer_formdata")[0].files,t=0;t<e.length;t++)a.append("farmer_excel",e[t]);$.ajax({url:"/post/insert/campaign/farmers",data:a,type:"POST",processData:!1,contentType:!1,success:function(a){manual_farmer_data=a,update_farmer_target_data(a),$.toast({heading:"Succefully Imported Farmers",text:"Data will be updated the next time you reload the page",position:"top-right",loaderBg:"#ff6849",icon:"success",hideAfter:5e3,stack:6})},error:function(a){a.responseJSON.Error.includes("Template Structure Not Proper")&&$.toast({heading:"Import Failure",text:a.responseJSON.Error,position:"top-right",loaderBg:"#ff6849",icon:"error",hideAfter:5e3})}})}),$('input[type=radio][name="TargetGroupTagType"]').on("change",function(){farmers_all.clear(),farmers_all.draw(),tag_ids=[],tag_arr=[],tags=[],$("#FarmerTags").change()}),$("#FarmerTags").on("change",function(){if(table_loader("loader_placer_farmer","farmers_all_wrapper"),"any"===$('input[name="TargetGroupTagType"]:checked').val())var a=get_tag_any_data();table_unloader("loader_div","farmers_all_wrapper"),0==a&&$('input[type=radio][name="TargetGroupTagType"]').change()});